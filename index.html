<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nairaland 3D Ludo â€” Single File (three.js)</title>
  <style>
    :root{--bg:#090c14;--panel:#0f1422;--muted:#a9b0c2;--accent:#6ee7f9;--accent-2:#9bffcb;--ok:#34d399;--warn:#f59e0b;--bad:#ef4444;--red:#d32f2f;--blue:#1976d2;--yellow:#fbbf24;--green:#22c55e;--glass:rgba(12,16,28,.68);--stroke:#24304f;--stroke-2:#1d2743;}
    :root[data-theme="light"]{--bg:#f6f7fb;--panel:#ffffff;--muted:#4b5563;--accent:#2563eb;--accent-2:#22c55e;--glass:rgba(255,255,255,.8);--stroke:#e5e7eb;--stroke-2:#e5e7eb;}
    html,body{height:100%;margin:0;background:radial-gradient(1000px 600px at 20% -10%,rgba(110,231,249,.06),transparent 40%),radial-gradient(800px 500px at 120% 40%,rgba(155,255,203,.07),transparent 50%),var(--bg);color:white;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
    body{color-scheme:dark;}
    :root[data-theme="light"] body{color-scheme:light;}
    #app{position:fixed;inset:0;display:grid;grid-template-rows:auto 1fr auto;}
    header{display:flex;align-items:center;gap:.75rem;padding:.65rem .9rem;background:linear-gradient(180deg,rgba(22,28,44,.9),rgba(14,16,22,.9));border-bottom:1px solid var(--stroke-2);backdrop-filter:saturate(140%) blur(8px);position:relative;z-index:10}
    :root[data-theme="light"] header{background:linear-gradient(180deg,rgba(255,255,255,.75),rgba(255,255,255,.55));}
    header .brand{display:flex;align-items:center;gap:.6rem}
    header .dot{width:10px;height:10px;border-radius:50%;box-shadow:0 0 10px rgba(110,231,249,.7)}
    header .title{font-weight:800;letter-spacing:.2px}
    header .sp{flex:1}
    header .btn{position:relative;background:#151c31;color:#e6ecff;border:1px solid #263150;padding:.45rem .7rem;border-radius:.55rem;cursor:pointer;transition:transform .08s ease,background .2s ease,border-color .2s ease;box-shadow:0 1px 0 rgba(255,255,255,.05) inset,0 8px 24px rgba(0,0,0,.22)}
    header .btn:hover{background:#1b2542;transform:translateY(-1px)}
    header .btn:active{transform:translateY(0)}
    header .btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#071018;border-color:#72e6ff;font-weight:800}
    header .btn.primary:hover{filter:saturate(115%)}
    header select,header input[type=checkbox]{background:#0c0f18;color:#cbd5e1;border:1px solid #27304a;padding:.35rem .5rem;border-radius:.35rem}
    :root[data-theme="light"] header select,:root[data-theme="light"] header input[type=checkbox]{background:#fff;color:#0f172a;border-color:#d1d5db}
    #canvas-wrap{position:relative;overflow:hidden}
    #hud{position:absolute;inset:0;pointer-events:none;}
    .panel{position:absolute;right:12px;top:12px;width:340px;max-width:calc(100% - 24px);background:var(--glass);border:1px solid var(--stroke);backdrop-filter:blur(10px) saturate(140%);border-radius:.9rem;padding:.9rem;pointer-events:auto;box-shadow:0 20px 40px rgba(0,0,0,.3)}
    .row{display:flex;align-items:center;gap:.6rem;margin:.45rem 0}
    .row label{font-size:.92rem;color:var(--muted)}
    .k{font-weight:700;color:#e6ecff}
    .turn{display:flex;align-items:center;gap:.6rem;padding:.55rem .7rem;border-radius:.6rem;background:linear-gradient(180deg,#0b1226,#0a0f1f);border:1px solid #203055;box-shadow:inset 0 1px 0 rgba(255,255,255,.04)}
    :root[data-theme="light"] .turn{background:linear-gradient(180deg,#ffffff,#f5f7fb);border-color:#e5e7eb}
    .pill{padding:.25rem .6rem;border-radius:1rem;font-weight:800;font-size:.78rem;box-shadow:0 1px 0 rgba(255,255,255,.06) inset}
    .pill.ok{background:rgba(52,211,153,.15);color:var(--ok);}
    .pill.warn{background:rgba(245,158,11,.15);color:var(--warn)}
    .rules-btn{margin-left:auto}
    .big-dice{font-variant-numeric:tabular-nums;font-size:1.72rem;font-weight:900;letter-spacing:.5px;text-shadow:0 8px 30px rgba(110,231,249,.25)}
    footer{display:flex;align-items:center;gap:.75rem;padding:.6rem .9rem;border-top:1px solid var(--stroke-2);background:linear-gradient(180deg,rgba(14,16,22,.92),rgba(14,16,22,.92));color:#a9b0c2;backdrop-filter:blur(6px)}
    :root[data-theme="light"] footer{background:linear-gradient(180deg,rgba(255,255,255,.8),rgba(255,255,255,.8));}
    footer .sp{flex:1}
    dialog{background:var(--panel);color:#e6ecff;border:1px solid var(--stroke);border-radius:1rem;width:min(820px,calc(100% - 32px));box-shadow:0 30px 60px rgba(0,0,0,.35)}
    dialog::backdrop{background:linear-gradient(180deg,rgba(0,0,0,.55),rgba(0,0,0,.6))}
    .modal-header{display:flex;align-items:center;gap:.75rem;padding:14px 16px;border-bottom:1px solid var(--stroke-2)}
    .modal-body{padding:14px 16px;line-height:1.6}
    .modal-body h3{margin:10px 0 6px;}
    .modal-body ul{margin:6px 0 12px 18px}
    .legend{display:grid;grid-template-columns:auto 1fr;gap:.35rem .75rem;align-items:center}
    .legend .sw{width:16px;height:16px;border-radius:4px;box-shadow:0 0 0 1px rgba(255,255,255,.15) inset,0 6px 16px rgba(0,0,0,.25)}
    .hint{color:#a9b0c2;font-size:.9rem}
    .toast{position:absolute;left:12px;bottom:12px;background:linear-gradient(180deg,rgba(9,12,20,.75),rgba(9,12,20,.9));padding:.48rem .7rem;border:1px solid var(--stroke);border-radius:.6rem;box-shadow:0 12px 28px rgba(0,0,0,.3)}
    #splash{position:absolute;inset:0;display:grid;place-items:center;background:radial-gradient(600px 320px at 20% -10%,rgba(110,231,249,.08),transparent 40%),var(--bg);z-index:2;transition:opacity .5s ease;}
    #splash.hide{opacity:0;pointer-events:none}
    .logo{display:flex;align-items:center;gap:.6rem;color:#e6ecff;font-weight:900;letter-spacing:.3px}
    .logo .lo-dot{width:12px;height:12px;border-radius:50%;background:var(--accent);box-shadow:0 0 18px var(--accent)}
    .logo small{opacity:.6;font-weight:600}
    .btn{overflow:hidden;position:relative;}
    .btn::after{content:"";position:absolute;inset:auto;width:0;height:0;border-radius:50%;background:radial-gradient(circle,rgba(255,255,255,.35),transparent 60%);transform:translate(-50%,-50%);pointer-events:none}
    .btn:active::after{width:180px;height:180px;top:var(--y,50%);left:var(--x,50%);transition:width .25s ease,height .25s ease}
    @keyframes pulse-glow{0%{box-shadow:0 0 0 0 rgba(110,231,249,.45)}70%{box-shadow:0 0 0 12px rgba(110,231,249,0)}100%{box-shadow:0 0 0 0 rgba(110,231,249,0)}}
    .pulse{animation:pulse-glow 1.6s ease-out infinite}
    @keyframes jiggle{0%,100%{transform:translateY(0)}50%{transform:translateY(-1px)}}
    .jiggle{animation:jiggle .6s ease-in-out infinite}
    ::-webkit-scrollbar{height:10px;width:10px}
    ::-webkit-scrollbar-thumb{background:#273451;border-radius:10px}
    :root[data-theme="light"] ::-webkit-scrollbar-thumb{background:#cbd5e1}
  </style>
</head>
<body>
<div id="app">
  <header>
    <div class="brand">
      <div class="dot" style="background:var(--accent)"></div>
      <div class="title">Nairaland 3D Ludo</div>
    </div>
    <div class="sp"></div>
    <label class="row">
      <span class="k">Players</span>
      <select id="playersSelect" title="Players">
        <option value="2">2 (You + AI)</option>
        <option value="3">3 (You + 2 AI)</option>
        <option value="4">4 (You + 3 AI)</option>
      </select>
    </label>
    <label class="row" title="Cinematic camera during moves">
      <input id="cinemaCam" type="checkbox" checked />
      <span>Camera FX</span>
    </label>
    <button id="themeBtn" class="btn" title="Toggle theme">Theme</button>
    <button id="startBtn" class="btn primary" title="Start a new game">Start Game</button>
    <button id="rulesBtn" class="btn rules-btn">Rules</button>
  </header>
  <div id="canvas-wrap">
    <canvas id="c"></canvas>
    <div id="hud">
      <div class="panel">
        <div class="row turn">
          <div>Turn:</div>
          <div id="turnBadge" class="pill" style="background:#2a2a40">â€”</div>
          <div class="sp"></div>
          <div class="big-dice" id="diceLabel">ðŸŽ² â€“</div>
        </div>
        <div class="row">
          <button id="rollBtn" class="btn">Roll (R)</button>
          <button id="undoBtn" class="btn" title="Undo last move (once)">Undo</button>
          <div class="sp"></div>
          <span class="hint">Click a glowing token to move</span>
        </div>
        <div class="row">
          <div class="legend">
            <div class="sw" style="background:var(--red)"></div><div>Red (You)</div>
            <div class="sw" style="background:var(--blue)"></div><div>Blue (AI)</div>
            <div class="sw" style="background:var(--yellow)"></div><div>Yellow (AI)</div>
            <div class="sw" style="background:var(--green)"></div><div>Green (AI)</div>
          </div>
        </div>
      </div>
      <div id="toast" class="toast" style="display:none"></div>
    </div>
  </div>
  <footer>
    <div>Built with three.js (CDN). Single HTML file as required.</div>
    <div class="sp"></div>
    <div>Hotkeys: R = Roll, 1â€“4 select token</div>
  </footer>
</div>

<div id="splash">
  <div class="logo">
    <div class="lo-dot"></div>
    <div>Loading Boardâ€¦ <small>three.js</small></div>
  </div>
</div>

<dialog id="rulesModal">
  <div class="modal-header">
    <div style="font-weight:800">3D Ludo â€” Rules & Features</div>
    <div class="sp"></div>
    <form method="dialog"><button class="btn">Close</button></form>
  </div>
  <div class="modal-body">
    <h3>Objective</h3>Get all four of your tokens from Home â†’ around the ring â†’ into your color's Home Stretch â†’ Center. First to finish wins.
    <h3>Core Rules</h3>
    <ul>
      <li>Roll a 6 to leave Home. Enter board at your color's Start tile.</li>
      <li>Move one token exactly the dice value. Roll 6 = extra roll.</li>
      <li>Captures: Landing on an opponent on a non-safe tile sends them back Home.</li>
      <li>Safe tiles: The four Start tiles are safe â€” no captures there.</li>
      <li>Home Stretch: After one full lap (â‰¥ 52 steps), continue into your 6-tile inner path to Center.</li>
      <li>Exact Entry: You must roll the exact number to reach the Center.</li>
    </ul>
    <h3>Unique Features</h3>
    <ul>
      <li>3D board with cinematic camera moves (toggle in header).</li>
      <li>Smart basic AI opponents (capture-first, progress-aware).</li>
      <li>Lucky Stars: Landing exactly on a star tile grants a bonus roll.</li>
      <li>One-click undo for the last move.</li>
      <li>Autosave: Game state persists locally; continue later.</li>
      <li>Keyboard play: R to roll, 1â€“4 to pick a token.</li>
    </ul>
    <div class="hint">Tip: Hover or rotate to view angles. Click glowing tokens to act.</div>
  </div>
</dialog>

<!-- Load three.js + controls (global scripts) -->
<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/controls/OrbitControls.js"></script>

<script>
// Splash auto-hide fallback
window.__nlSplashTimeout = setTimeout(function(){
  var sp = document.getElementById('splash'); if (sp) sp.classList.add('hide');
}, 2500);

// Wait for three.js to load before starting game
function initGame() {
  if (typeof THREE === 'undefined' || !THREE.Scene) {
    setTimeout(initGame, 50);
    return;
  }
  try { if (window.__nlSplashTimeout) clearTimeout(window.__nlSplashTimeout); } catch(e){}

  // Game code starts here
const canvas = document.getElementById('c');
const renderer = new THREE.WebGLRenderer({canvas,antialias:true,alpha:true});
renderer.setPixelRatio(Math.min(devicePixelRatio,2));
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x0b0f19);
const camera = new THREE.PerspectiveCamera(55,1,0.1,1000);
const controls = new THREE.OrbitControls(camera,renderer.domElement);
controls.enableDamping=true;controls.dampingFactor=0.08;controls.enablePan=false;
controls.minDistance=18;controls.maxDistance=65;controls.maxPolarAngle=Math.PI*0.495;
function resize(){const w=canvas.clientWidth||canvas.parentElement.clientWidth;const h=canvas.clientHeight||canvas.parentElement.clientHeight;renderer.setSize(w,h,false);camera.aspect=w/h;camera.updateProjectionMatrix();}
const wrap=document.getElementById('canvas-wrap');
function fitCanvas(){const r=wrap.getBoundingClientRect();canvas.style.width=r.width+'px';canvas.style.height=r.height+'px';resize();}
window.addEventListener('resize',fitCanvas);fitCanvas();
const amb=new THREE.AmbientLight(0xbcc5e3,0.8);scene.add(amb);
const dir=new THREE.DirectionalLight(0xffffff,1.0);dir.position.set(20,40,20);scene.add(dir);
const rim=new THREE.DirectionalLight(0x88bbff,0.4);rim.position.set(-30,25,-20);scene.add(rim);
const ground=new THREE.Mesh(new THREE.CylinderGeometry(40,40,0.6,72),new THREE.MeshStandardMaterial({color:0x0a0f1e,metalness:.2,roughness:.8}));
ground.position.y=-0.4;scene.add(ground);
const COLORS={red:{hex:0xd32f2f,css:'var(--red)'},blue:{hex:0x1976d2,css:'var(--blue)'},yellow:{hex:0xfbbf24,css:'var(--yellow)'},green:{hex:0x22c55e,css:'var(--green)'}};
const PLAYER_ORDER=['red','blue','yellow','green'];
const PLAYER_NAME={red:'Red',blue:'Blue',yellow:'Yellow',green:'Green'};
const RING_COUNT=52;const HOME_STEPS=6;const TILE_SIZE=1.2;const RADIUS=18;
const ringPositions=[];for(let i=0;i<RING_COUNT;i++){const a=(i/RING_COUNT)*Math.PI*2;const x=Math.cos(a)*RADIUS;const z=Math.sin(a)*RADIUS;ringPositions.push(new THREE.Vector3(x,0,z));}
const startIndex={red:0,blue:13,yellow:26,green:39};
const safeIndices=new Set([startIndex.red,startIndex.blue,startIndex.yellow,startIndex.green]);
const homePaths={red:[],blue:[],yellow:[],green:[]};
for(const p of PLAYER_ORDER){const si=startIndex[p];const a=(si/RING_COUNT)*Math.PI*2;for(let k=0;k<HOME_STEPS;k++){const t=(k+1)/(HOME_STEPS+1);const x=Math.cos(a)*(RADIUS*(1-t));const z=Math.sin(a)*(RADIUS*(1-t));homePaths[p].push(new THREE.Vector3(x,0,z));}}
const tileGroup=new THREE.Group();scene.add(tileGroup);
const tileGeom=new THREE.BoxGeometry(TILE_SIZE,0.25,TILE_SIZE);
const matDefault=new THREE.MeshStandardMaterial({color:0x24314f,metalness:.1,roughness:.9});
const matsQuad=[0xd32f2f,0x1976d2,0xfbbf24,0x22c55e].map(c=>new THREE.MeshStandardMaterial({color:c,metalness:.2,roughness:.7}));
const starMat=new THREE.MeshStandardMaterial({color:0x6ee7f9,emissive:0x0d3d54,emissiveIntensity:.7,metalness:.4,roughness:.5});
const STAR_TILES=[3,16,29,42];
const ringTileMeshes=[];
for(let i=0;i<RING_COUNT;i++){const tile=new THREE.Mesh(tileGeom,matDefault.clone());tile.position.copy(ringPositions[i]);tile.position.y=0.125;tile.rotation.y=Math.atan2(tile.position.x,tile.position.z);const q=Math.floor((i/RING_COUNT)*4);const m=tile.material;m.color.lerp(new THREE.Color(matsQuad[q].color),0.35);if(safeIndices.has(i)){m.emissive=new THREE.Color(matsQuad[q].color);m.emissiveIntensity=0.2;}tileGroup.add(tile);ringTileMeshes.push(tile);if(STAR_TILES.includes(i)){const tor=new THREE.Mesh(new THREE.TorusGeometry(0.35,0.12,10,20),starMat);tor.position.copy(tile.position);tor.position.y+=0.2;tor.rotation.x=Math.PI/2;tileGroup.add(tor);}}
const homeTileMeshes={red:[],blue:[],yellow:[],green:[]};
const homeMat=new THREE.MeshStandardMaterial({color:0x2a375c,metalness:.2,roughness:.9});
for(const p of PLAYER_ORDER){for(let k=0;k<HOME_STEPS;k++){const tile=new THREE.Mesh(tileGeom,homeMat.clone());tile.position.copy(homePaths[p][k]);tile.position.y=0.14;const c=new THREE.Color(COLORS[p].hex);tile.material.color.lerp(c,0.45);if(k===HOME_STEPS-1){tile.material.emissive=c;tile.material.emissiveIntensity=.25;}scene.add(tile);homeTileMeshes[p].push(tile);}}
const hub=new THREE.Mesh(new THREE.CylinderGeometry(3.8,3.8,0.5,48),new THREE.MeshStandardMaterial({color:0x0e1530,metalness:.4,roughness:.4}));
hub.position.y=0.1;scene.add(hub);
const nestGroup=new THREE.Group();scene.add(nestGroup);
function makeNest(x,z,color){const g=new THREE.CylinderGeometry(2.2,2.2,0.32,24);const m=new THREE.MeshStandardMaterial({color,metalness:.3,roughness:.7});const n=new THREE.Mesh(g,m);n.position.set(x,0.16,z);nestGroup.add(n);return n;}
function polar(r,ang){return new THREE.Vector3(Math.cos(ang)*r,0.16,Math.sin(ang)*r);}
const nest={red:makeNest(...polar(RADIUS+6,(startIndex.red/RING_COUNT)*Math.PI*2).toArray().slice(0,3)),blue:makeNest(...polar(RADIUS+6,(startIndex.blue/RING_COUNT)*Math.PI*2).toArray().slice(0,3)),yellow:makeNest(...polar(RADIUS+6,(startIndex.yellow/RING_COUNT)*Math.PI*2).toArray().slice(0,3)),green:makeNest(...polar(RADIUS+6,(startIndex.green/RING_COUNT)*Math.PI*2).toArray().slice(0,3))};
const tokenGeom=new THREE.SphereGeometry(0.5,24,16);
function makeTokenMesh(color){const body=new THREE.Mesh(tokenGeom,new THREE.MeshStandardMaterial({color,metalness:.3,roughness:.4}));body.castShadow=false;body.receiveShadow=false;return body;}
const TOKEN_PER_PLAYER=4;
const tokens={red:[],blue:[],yellow:[],green:[]};
function nestSlots(center){const off=[[-0.7,-0.7],[0.7,-0.7],[-0.7,0.7],[0.7,0.7]];return off.map(([dx,dz])=>new THREE.Vector3(center.x+dx,0.6,center.z+dz));}
const nestCenters={red:nest.red.position.clone(),blue:nest.blue.position.clone(),yellow:nest.yellow.position.clone(),green:nest.green.position.clone()};
for(const p of PLAYER_ORDER){const slots=nestSlots(nestCenters[p]);for(let i=0;i<TOKEN_PER_PLAYER;i++){const t=makeTokenMesh(COLORS[p].hex);t.userData={player:p,id:i,state:'home',ringIndex:null,steps:0,homeIndex:null};t.position.copy(slots[i]);scene.add(t);tokens[p].push(t);}}
const diceGroup=new THREE.Group();scene.add(diceGroup);diceGroup.position.set(0,6.5,0);
const diceGeom=new THREE.BoxGeometry(1.6,1.6,1.6);
const pip=(n)=>new THREE.MeshStandardMaterial({color:0xf2f5ff,emissive:0x111,metalness:.2,roughness:.6});
const diceMats=[pip(1),pip(2),pip(3),pip(4),pip(5),pip(6)];
const dice=new THREE.Mesh(diceGeom,diceMats);dice.castShadow=false;diceGroup.add(dice);
const FACE_ORIENT={1:new THREE.Euler(0,0,0),2:new THREE.Euler(0,Math.PI/2,0),3:new THREE.Euler(Math.PI/2,0,0),4:new THREE.Euler(-Math.PI/2,0,0),5:new THREE.Euler(0,-Math.PI/2,0),6:new THREE.Euler(Math.PI,0,0)};
function animateDiceTo(value){const base=FACE_ORIENT[value];const extra=new THREE.Euler(Math.random()*Math.PI*4,Math.random()*Math.PI*4,Math.random()*Math.PI*4);const targetQ=new THREE.Quaternion().setFromEuler(new THREE.Euler(base.x+extra.x,base.y+extra.y,base.z+extra.z));const startQ=dice.quaternion.clone();const dur=650+Math.random()*550;const t0=performance.now();return new Promise(res=>{function spin(){const t=(performance.now()-t0)/dur;const k=t<1?t:1;THREE.Quaternion.slerp(startQ,targetQ,dice.quaternion,0.2*Math.sin(k*Math.PI)+k*0.8);if(t<1)requestAnimationFrame(spin);else{dice.quaternion.copy(new THREE.Quaternion().setFromEuler(base));res();}}requestAnimationFrame(spin);});}
function placeCamera(){camera.position.set(34,34,34);camera.lookAt(0,0,0);controls.update();}
placeCamera();
const ui={startBtn:document.getElementById('startBtn'),rulesBtn:document.getElementById('rulesBtn'),playersSelect:document.getElementById('playersSelect'),rollBtn:document.getElementById('rollBtn'),undoBtn:document.getElementById('undoBtn'),turnBadge:document.getElementById('turnBadge'),diceLabel:document.getElementById('diceLabel'),cinemaCam:document.getElementById('cinemaCam'),toast:document.getElementById('toast'),rulesModal:document.getElementById('rulesModal'),themeBtn:document.getElementById('themeBtn')};
let game={players:2,order:['red','blue','yellow','green'],activeCount:2,turnIdx:0,rolled:null,canUndo:null,finished:false,history:[],autosaveKey:'nl3d-ludo-v1',ai:{blue:true,yellow:true,green:true},hasStarted:false};
function activePlayers(){return game.order.slice(0,game.activeCount);}
function activePlayer(){return activePlayers()[game.turnIdx];}
function updateCTAs(){if(!game.hasStarted)ui.startBtn.classList.add('pulse');else ui.startBtn.classList.remove('pulse');const humanTurn=activePlayer()==='red'&&!game.finished&&game.rolled==null;ui.rollBtn.classList.toggle('jiggle',humanTurn);}
function setTurnBadge(){const p=activePlayer();ui.turnBadge.textContent=PLAYER_NAME[p];ui.turnBadge.style.background=getComputedStyle(document.documentElement).getPropertyValue(COLORS[p].css);updateCTAs();}
function setDiceLabel(n){ui.diceLabel.textContent=`ðŸŽ² ${n??'â€“'}`;}
function setToast(msg,t=1800){ui.toast.textContent=msg;ui.toast.style.display='block';clearTimeout(ui.toast._t);ui.toast._t=setTimeout(()=>ui.toast.style.display='none',t);}
function tokenStateAll(){const out=[];for(const p of PLAYER_ORDER){for(const t of tokens[p])out.push({p,id:t.userData.id,state:{...t.userData}});}return out;}
function restoreTokenStates(states){for(const s of states){const t=tokens[s.p][s.id];t.userData={...t.userData,...s.state};placeToken(t);}}
function save(){try{localStorage.setItem(game.autosaveKey,JSON.stringify({g:{...game,canUndo:null,history:[]},tokens:tokenStateAll()}));}catch(e){}}
function load(){try{const raw=localStorage.getItem(game.autosaveKey);if(!raw)return false;const data=JSON.parse(raw);const g=data.g;game={...game,...g};restoreTokenStates(data.tokens);setTurnBadge();setDiceLabel(game.rolled);return true;}catch(e){return false;}}
function placeToken(t){const ud=t.userData;if(ud.state==='home'){const slots=nestSlots(nestCenters[ud.player]);const idx=ud.id%4;const pos=slots[idx];t.position.copy(pos);}else if(ud.state==='ring'){t.position.copy(ringPositions[ud.ringIndex]);t.position.y=0.62;}else if(ud.state==='homestretch'){t.position.copy(homePaths[ud.player][ud.homeIndex]);t.position.y=0.62;}else if(ud.state==='finished'){const c=homePaths[ud.player][HOME_STEPS-1].clone();c.y=1.1;t.position.copy(c);}}
function isHuman(p){return p==='red';}
function isAI(p){return !isHuman(p);}
function legalMoves(p,roll){const L=[];for(const t of tokens[p]){const ud=t.userData;if(ud.state==='finished')continue;if(ud.state==='home'){if(roll===6){L.push({t,kind:'enter',from:null,toIndex:startIndex[p]});}}else if(ud.state==='ring'){const nextSteps=ud.steps+roll;if(nextSteps<52){const toIndex=(ud.ringIndex+roll)%RING_COUNT;L.push({t,kind:'ring',from:ud.ringIndex,toIndex});}else{const into=nextSteps-52;if(into<=HOME_STEPS){const toHome=into-1;L.push({t,kind:'enterHome',toHome});}}}else if(ud.state==='homestretch'){const to=ud.homeIndex+roll;if(to===HOME_STEPS){L.push({t,kind:'finish'});}else if(to<HOME_STEPS){L.push({t,kind:'home',toHome:to});}}}return L;}
function tileOccupantsOnRing(idx){const occ=[];for(const p of activePlayers()){for(const t of tokens[p]){if(t.userData.state==='ring'&&t.userData.ringIndex===idx)occ.push(t);}}return occ;}
function captureIfNeeded(p,idx){if(safeIndices.has(idx))return [];const occ=tileOccupantsOnRing(idx).filter(t=>t.userData.player!==p);for(const e of occ){e.userData={...e.userData,state:'home',ringIndex:null,steps:0,homeIndex:null};placeToken(e);}return occ;}
function moveAlongRing(t,steps){return new Promise(async(resolve)=>{for(let s=0;s<steps;s++){const fromIdx=t.userData.ringIndex;const toIdx=(fromIdx+1)%RING_COUNT;const from=ringPositions[fromIdx];const to=ringPositions[toIdx];await tweenToken(t,from,to,160);t.userData.ringIndex=toIdx;t.userData.steps+=1;placeToken(t);}resolve();});}
function tweenToken(t,a,b,dur){return new Promise((res)=>{const start=performance.now();const y0=t.position.y;function anim(){const k=Math.min(1,(performance.now()-start)/dur);t.position.lerpVectors(a,b,k);t.position.y=y0+Math.sin(k*Math.PI)*0.25;if(k<1)requestAnimationFrame(anim);else{t.position.y=y0;res();}}requestAnimationFrame(anim);});}
function tweenTo(t,target,dur){return new Promise((res)=>{const start=performance.now();const from=t.position.clone();const y0=from.y;function anim(){const k=Math.min(1,(performance.now()-start)/dur);t.position.lerpVectors(from,target,k);t.position.y=y0+Math.sin(k*Math.PI)*0.25;if(k<1)requestAnimationFrame(anim);else res();}requestAnimationFrame(anim);});}
async function performMove(mv,rolled){const p=mv.t.userData.player;const preState=tokenStateAll();if(ui.cinemaCam.checked){const pos=mv.t.position.clone();const dirV=pos.clone().normalize();const camPos=pos.clone().addScaledVector(dirV,8).add(new THREE.Vector3(0,6,0));await smoothCamera(camPos,pos.clone().setY(0));}
if(mv.kind==='enter'){mv.t.userData={...mv.t.userData,state:'ring',ringIndex:startIndex[p],steps:0,homeIndex:null};await tweenTo(mv.t,ringPositions[startIndex[p]].clone().setY(0.62),220);const cap=captureIfNeeded(p,startIndex[p]);placeToken(mv.t);}else if(mv.kind==='ring'){await moveAlongRing(mv.t,rolled);const cap=captureIfNeeded(p,mv.t.userData.ringIndex);}else if(mv.kind==='enterHome'){const remain=(mv.t.userData.steps+rolled)-52;if(mv.t.userData.steps<52){await moveAlongRing(mv.t,52-mv.t.userData.steps);}const idx=remain-1;mv.t.userData={...mv.t.userData,state:'homestretch',ringIndex:null,homeIndex:idx};await tweenTo(mv.t,homePaths[p][idx].clone().setY(0.62),220);}else if(mv.kind==='home'){mv.t.userData.homeIndex=mv.toHome;await tweenTo(mv.t,homePaths[p][mv.toHome].clone().setY(0.62),200);}else if(mv.kind==='finish'){mv.t.userData={...mv.t.userData,state:'finished',homeIndex:HOME_STEPS-1};await tweenTo(mv.t,homePaths[p][HOME_STEPS-1].clone().setY(1.12),240);}
let bonus=false;if(mv.kind==='ring'||mv.kind==='enter'){const idx=mv.t.userData.ringIndex;if(STAR_TILES.includes(idx))bonus=true;}
game.canUndo=preState;save();return{bonus};}
function hasWon(p){return tokens[p].every(t=>t.userData.state==='finished');}
function nextTurn(extra=false){if(!extra){game.turnIdx=(game.turnIdx+1)%game.activeCount;}setTurnBadge();game.rolled=null;setDiceLabel(null);enableRoll(true);}
function enableRoll(on){ui.rollBtn.disabled=!on||game.finished;}
function enableUndo(on){ui.undoBtn.disabled=!on;}
function pickAIMove(p,roll,moves){const copy=moves.slice();for(const mv of copy){if(mv.kind==='ring'){const toIdx=(mv.t.userData.ringIndex+roll)%RING_COUNT;mv.capture=tileOccupantsOnRing(toIdx).some(t=>t.userData.player!==p)&&!safeIndices.has(toIdx);}else if(mv.kind==='enter'){const toIdx=startIndex[p];mv.capture=tileOccupantsOnRing(toIdx).some(t=>t.userData.player!==p)&&!safeIndices.has(toIdx);}else mv.capture=false;}const byCap=copy.filter(m=>m.capture);if(byCap.length)return byCap[Math.floor(Math.random()*byCap.length)];copy.sort((a,b)=>(b.t.userData.steps??0)-(a.t.userData.steps??0));return copy[0];}
let selecting=false;let currentMoves=[];
async function roll(){if(game.finished)return;enableRoll(false);enableUndo(false);const v=1+Math.floor(Math.random()*6);game.rolled=v;setDiceLabel(v);await animateDiceTo(v);const p=activePlayer();const moves=legalMoves(p,v);currentMoves=moves;selecting=true;if(!moves.length){setToast('No moves â€” turn passes');return nextTurn(false);}if(isAI(p)){const mv=pickAIMove(p,v,moves);const{bonus}=await performMove(mv,v);if(hasWon(p)){game.finished=true;setToast(`${PLAYER_NAME[p]} wins! ðŸŽ‰`,4000);return;}enableUndo(true);return nextTurn(v===6||bonus);}else{highlightMoves(moves,true);setToast('Pick a glowing token');}}
function highlightMoves(moves,on){for(const mv of moves){const t=mv.t;t.material.emissive=new THREE.Color(0xffffff);t.material.emissiveIntensity=on?0.35:0;}}
async function onTokenClick(obj){if(!selecting)return;const p=activePlayer();if(obj.userData?.player!==p)return;const mv=currentMoves.find(m=>m.t===obj);if(!mv)return;selecting=false;highlightMoves(currentMoves,false);const{bonus}=await performMove(mv,game.rolled);if(hasWon(p)){game.finished=true;setToast(`${PLAYER_NAME[p]} wins! ðŸŽ‰`,4000);return;}enableUndo(true);nextTurn(game.rolled===6||bonus);}
async function smoothCamera(pos,look){const fromP=camera.position.clone();const fromT=controls.target.clone();const t0=performance.now();const dur=500;return new Promise(res=>{function step(){const k=Math.min(1,(performance.now()-t0)/dur);camera.position.lerpVectors(fromP,pos,k);controls.target.lerpVectors(fromT,look,k);controls.update();if(k<1)requestAnimationFrame(step);else res();}requestAnimationFrame(step);});}
const raycaster=new THREE.Raycaster();const pointer=new THREE.Vector2();
function onPointer(ev){const r=canvas.getBoundingClientRect();pointer.x=((ev.clientX-r.left)/r.width)*2-1;pointer.y=-((ev.clientY-r.top)/r.height)*2+1;raycaster.setFromCamera(pointer,camera);const intersects=raycaster.intersectObjects([].concat(...activePlayers().map(p=>tokens[p])));if(intersects.length){onTokenClick(intersects[0].object);}}
canvas.addEventListener('pointerdown',onPointer);
window.addEventListener('keydown',(e)=>{if(e.key==='r'||e.key==='R')roll();if('1234'.includes(e.key)&&isHuman(activePlayer())&&currentMoves.length){const idx=Number(e.key)-1;const mine=currentMoves.filter(m=>m.t.userData.player===activePlayer());if(mine[idx])onTokenClick(mine[idx].t);}});
ui.rollBtn.addEventListener('click',roll);
ui.undoBtn.addEventListener('click',()=>{if(!game.canUndo)return;restoreTokenStates(game.canUndo);game.canUndo=null;enableUndo(false);save();setToast('Undone');});
ui.startBtn.addEventListener('click',()=>{const pcount=Number(ui.playersSelect.value);game={...game,activeCount:pcount,turnIdx:0,rolled:null,finished:false,canUndo:null,hasStarted:true};for(const p of PLAYER_ORDER){for(const t of tokens[p]){t.userData={player:p,id:t.userData.id,state:'home',ringIndex:null,steps:0,homeIndex:null};placeToken(t);}}game.ai={blue:true,yellow:pcount>=3,green:pcount>=4};setTurnBadge();setDiceLabel(null);enableRoll(true);enableUndo(false);updateCTAs();save();setToast('New game!');});
ui.rulesBtn.addEventListener('click',()=>ui.rulesModal.showModal());
const THEME_KEY='nl3d-theme';
function applyTheme(t){document.documentElement.setAttribute('data-theme',t);localStorage.setItem(THEME_KEY,t);}
applyTheme(localStorage.getItem(THEME_KEY)||'dark');
ui.themeBtn.addEventListener('click',()=>{const cur=document.documentElement.getAttribute('data-theme')||'dark';applyTheme(cur==='dark'?'light':'dark');});
document.querySelectorAll('.btn').forEach(btn=>{btn.addEventListener('pointerdown',e=>{const r=btn.getBoundingClientRect();btn.style.setProperty('--x',(e.clientX-r.left)+'px');btn.style.setProperty('--y',(e.clientY-r.top)+'px');});});
setTurnBadge();setDiceLabel(null);enableRoll(true);enableUndo(false);
load();
updateCTAs();
if(!game.hasStarted)setToast('Click Start Game to begin');
let firstFrame=true;
function loop(){controls.update();renderer.render(scene,camera);if(firstFrame){firstFrame=false;const sp=document.getElementById('splash');sp&&setTimeout(()=>sp.classList.add('hide'),100);}requestAnimationFrame(loop);}
loop();
} // end initGame

// Start game when DOM and libraries are ready
if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',initGame);}else{initGame();}
</script>
</body>
</html>
